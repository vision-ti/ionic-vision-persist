!function(){"use strict";angular.module("vision.persist",["ngCordova","vision.event"]).factory("$connectionFactory",["$cordovaSQLite","$window",function(a,b){function c(c){e=b.cordova?a.openDB(c.name):window.openDatabase(c.name,"1.0","database",-1),f=c.showSQL,g=c.entities;var h,i;for(var j in g){i=g[j],h=[];for(var k in i)h.push(k+" "+i[k].type);var l="CREATE TABLE IF NOT EXISTS "+j+" ("+h.join(",")+")";d(l)}}function d(b,c){return a.execute(e,b,c).then(function(a){return f&&console.info("SqlQuery: "+b),a},function(a){throw a})}var e=void 0,f=!1,g={};return{getDb:function(){return e},getEntities:function(){return g},init:c,execute:d}}]).factory("DataSet",["VsUtil","$connectionFactory","VisionEventDispatcher",function(a,b,c){var d=function(d){function e(){var a=[],c="insert into "+g.entityName+" (",d="",e=b.getEntities()[g.entityName];for(var f in e)"$$hashKey"!=f&&(c+=" "+f+", ",d+=" ?, ","id"==f&&void 0==g.entity[f]&&(g.entity[f]=null),a.push(g.entity[f]));return c=c.substr(0,c.length-2),d=d.substr(0,d.length-2),c+=") values ("+d+")",{sql:c,parameters:a}}function f(){var a=[],c="update "+g.entityName+" set ",d=b.getEntities()[g.entityName];for(var e in d)"id"!=e&&"$$hashKey"!=e&&(c+=" "+e+" = ?, ",a.push(g.entity[e]));return c=c.substr(0,c.length-2),c+=" where id = ? ",a.push(d.id),{sql:c,parameters:a}}var g=this,h=!1;this.entityName=d,this.entity={},this.appendAfterSave=!1,this.resultList=[],c.call(this),this.append=function(){h=!1,this.entity={},this.dispatch(new DataSetEvent(DataSetEvent.AFTER_APPEND))},this.cancel=function(){h=!0},this.save=function(){if(h=!1,this.dispatch(new DataSetEvent(DataSetEvent.BEFORE_SAVE)),h){var c=$q.defer();return $timeout(function(){c.reject()}),c.promise}var d;return d=a.isFilled(g.entity.id)?f():e(),b.execute(d.sql,d.parameters).then(function(a){g.appendAfterSave&&g.append(),g.dispatch(new DataSetEvent(DataSetEvent.AFTER_SAVE),a)})},this.remove=function(){if(this.dispatch(new DataSetEvent(DataSetEvent.BEFORE_REMOVE)),!a.isFilled(this.entity.id))throw"ID is required for remove operation.";var c=[this.entity.id];return b.execute("delete from "+this.entityName+" where id = (?)",c).then(function(a){return g.dispatch(new DataSetEvent(DataSetEvent.AFTER_REMOVE,a)),a})},this.get=function(a){return this.entity={},b.execute("select * from "+this.entityName+" where id = (?)",[a]).then(function(a){return g.entity=a.rows.item(0),g.dispatch(new DataSetEvent(DataSetEvent.GET_RESULT,g.entity)),g.entity})},this.all=function(){return b.execute("select * from "+this.entityName).then(function(a){g.resultList=[];for(var b=0;b<a.rows.length;b++)g.resultList.push(a.rows.item(b));return g.dispatch(new DataSetEvent(DataSetEvent.GET_ALL_RESULT,g.resultList)),g.resultList})}};return d.prototype=new c,d}])}();var DataSetEvent=function(a,b){VisionEvent.call(this,a,b)};DataSetEvent.prototype=new VisionEvent,DataSetEvent.AFTER_APPEND="ds:afterAppend",DataSetEvent.BEFORE_SAVE="ds:beforeSave",DataSetEvent.AFTER_SAVE="ds:afterSave",DataSetEvent.BEFORE_REMOVE="ds:beforeRemove",DataSetEvent.AFTER_REMOVE="ds:afterRemove",DataSetEvent.GET_RESULT="ds:getResult",DataSetEvent.GET_ALL_RESULT="ds:getAllResult";